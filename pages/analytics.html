{{define "content"}}
<div class="space-y-6" x-data="{
    activeTab: 'general',
    chartFilter: 'both',
    chart: null,
    netWorthChart: null,
    dailyData: {{.DailyReturnsJSON}} || [],
    netWorthData: {{.NetWorthDataJSON}} || [],
    initChart() {
        if (!this.chart && this.dailyData.length > 0) {
            const ctx = document.getElementById('dailyReturnsChart').getContext('2d');
            
            // Format labels
            const labels = this.dailyData.map(d => {
                // Parse date string and add time to ensure correct date
                const [year, month, day] = d.date.split('-');
                const date = new Date(year, month - 1, day);
                const monthName = date.toLocaleDateString('en-US', { month: 'short' });
                return monthName + ' ' + date.getDate();
            });
            
            this.chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Premiums',
                            data: this.dailyData.map(d => d.premiums),
                            backgroundColor: 'rgba(34, 197, 94, 0.8)',
                            borderColor: 'rgb(34, 197, 94)',
                            borderWidth: 1
                        },
                        {
                            label: 'Stock Gains',
                            data: this.dailyData.map(d => d.stockGains),
                            backgroundColor: 'rgba(59, 130, 246, 0.8)',
                            borderColor: 'rgb(59, 130, 246)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            stacked: true
                        },
                        y: {
                            stacked: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': $' + context.parsed.y.toLocaleString();
                                }
                            }
                        },
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    }
                }
            });
        }
    },
    updateChart() {
        if (!this.chart || this.dailyData.length === 0) return;
        
        // Format labels
        const labels = this.dailyData.map(d => {
            const date = new Date(d.date);
            const month = date.toLocaleDateString('en-US', { month: 'short' });
            const day = date.getDate();
            return month + ' ' + day;
        });
        
        // Destroy and recreate the chart to avoid update issues
        this.chart.destroy();
        const ctx = document.getElementById('dailyReturnsChart').getContext('2d');
        
        let datasets = [];
        if (this.chartFilter === 'premiums') {
            datasets = [{
                label: 'Premiums',
                data: this.dailyData.map(d => d.premiums),
                backgroundColor: 'rgba(34, 197, 94, 0.8)',
                borderColor: 'rgb(34, 197, 94)',
                borderWidth: 1
            }];
        } else if (this.chartFilter === 'stocks') {
            datasets = [{
                label: 'Stock Gains',
                data: this.dailyData.map(d => d.stockGains),
                backgroundColor: 'rgba(59, 130, 246, 0.8)',
                borderColor: 'rgb(59, 130, 246)',
                borderWidth: 1
            }];
        } else {
            datasets = [
                {
                    label: 'Premiums',
                    data: this.dailyData.map(d => d.premiums),
                    backgroundColor: 'rgba(34, 197, 94, 0.8)',
                    borderColor: 'rgb(34, 197, 94)',
                    borderWidth: 1
                },
                {
                    label: 'Stock Gains',
                    data: this.dailyData.map(d => d.stockGains),
                    backgroundColor: 'rgba(59, 130, 246, 0.8)',
                    borderColor: 'rgb(59, 130, 246)',
                    borderWidth: 1
                }
            ];
        }
        
        this.chart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        stacked: (this.chartFilter === 'both')
                    },
                    y: {
                        stacked: (this.chartFilter === 'both'),
                        ticks: {
                            callback: function(value) {
                                return '$' + value.toLocaleString();
                            }
                        }
                    }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': $' + context.parsed.y.toLocaleString();
                            }
                        }
                    },
                    legend: {
                        display: true,
                        position: 'top'
                    }
                }
            }
        });
    },
    initNetWorthChart() {
        if (!this.netWorthChart && this.netWorthData.length > 0) {
            const ctx = document.getElementById('netWorthChart').getContext('2d');

            // Format labels (month names)
            const labels = this.netWorthData.map(d => {
                const [year, month] = d.month.split('-');
                const date = new Date(year, month - 1, 1);
                return date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
            });

            // Create stacked bar chart
            this.netWorthChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Savings',
                            data: this.netWorthData.map(d => d.savingsBalance),
                            backgroundColor: 'rgba(34, 197, 94, 0.8)',
                            borderColor: 'rgb(34, 197, 94)',
                            borderWidth: 1
                        },
                        {
                            label: 'Brokerage',
                            data: this.netWorthData.map(d => d.brokerageBalance),
                            backgroundColor: 'rgba(59, 130, 246, 0.8)',
                            borderColor: 'rgb(59, 130, 246)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            stacked: true
                        },
                        y: {
                            stacked: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': $' + context.parsed.y.toLocaleString();
                                },
                                footer: function(tooltipItems) {
                                    let total = 0;
                                    tooltipItems.forEach(function(tooltipItem) {
                                        total += tooltipItem.parsed.y;
                                    });
                                    return 'Total: $' + total.toLocaleString();
                                }
                            }
                        },
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        // Plugin to display total above bars
                        datalabels: false
                    }
                },
                plugins: [{
                    id: 'totalLabel',
                    afterDatasetsDraw: function(chart) {
                        const ctx = chart.ctx;
                        chart.data.datasets[0].data.forEach(function(value, index) {
                            const dataset1 = chart.data.datasets[0].data[index];
                            const dataset2 = chart.data.datasets[1].data[index];
                            const total = dataset1 + dataset2;

                            const meta = chart.getDatasetMeta(1);
                            const bar = meta.data[index];

                            ctx.fillStyle = 'black';
                            ctx.font = 'bold 12px sans-serif';
                            ctx.textAlign = 'center';
                            ctx.fillText('$' + total.toLocaleString(), bar.x, bar.y - 5);
                        });
                    }
                }]
            });
        }
    }
}">
    <h2 class="text-2xl font-bold text-gray-900">Analytics</h2>
    
    <!-- Tab Navigation -->
    <div class="border-b border-gray-200">
        <nav class="-mb-px flex space-x-8" aria-label="Tabs">
            <button @click="activeTab = 'general'"
                    :class="activeTab === 'general' ? 'border-indigo-500 text-indigo-600' : 'border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700'"
                    class="whitespace-nowrap border-b-2 py-4 px-1 text-sm font-medium">
                General
            </button>
            <button @click="activeTab = 'daily'; $nextTick(() => initChart())"
                    :class="activeTab === 'daily' ? 'border-indigo-500 text-indigo-600' : 'border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700'"
                    class="whitespace-nowrap border-b-2 py-4 px-1 text-sm font-medium">
                Daily
            </button>
            <button @click="activeTab = 'networth'; $nextTick(() => initNetWorthChart())"
                    :class="activeTab === 'networth' ? 'border-indigo-500 text-indigo-600' : 'border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700'"
                    class="whitespace-nowrap border-b-2 py-4 px-1 text-sm font-medium">
                Net Worth
            </button>
        </nav>
    </div>
    
    <!-- General Tab Content -->
    <div x-show="activeTab === 'general'" class="bg-white">
        <div class="mx-auto">
            <div class="grid grid-cols-1 gap-px bg-gray-900/5 sm:grid-cols-2 lg:grid-cols-4">
                <!-- Total Portfolio Value -->
                <div class="bg-white px-4 py-6 sm:px-6 lg:px-8">
                    <p class="text-sm/6 font-medium text-gray-500">Total Portfolio Value</p>
                    <p class="mt-2 flex items-baseline gap-x-2">
                        <span class="text-4xl font-semibold tracking-tight text-gray-900">{{.TotalPortfolioValueFormatted}}</span>
                    </p>
                </div>

                <!-- Total Active Capital -->
                <div class="bg-white px-4 py-6 sm:px-6 lg:px-8">
                    <p class="text-sm/6 font-medium text-gray-500">Total Active Capital</p>
                    <p class="mt-2 flex items-baseline gap-x-2">
                        <span class="text-4xl font-semibold tracking-tight text-gray-900">{{.TotalActiveCapitalFormatted}}</span>
                    </p>
                </div>

                <!-- Total Capital Deployed -->
                <div class="bg-white px-4 py-6 sm:px-6 lg:px-8">
                    <p class="text-sm/6 font-medium text-gray-500">Total Capital Deployed</p>
                    <p class="mt-2 flex items-baseline gap-x-2">
                        <span class="text-4xl font-semibold tracking-tight text-gray-900">{{.TotalCapitalFormatted}}</span>
                    </p>
                </div>

                <!-- Total Deposits -->
                <div class="bg-white px-4 py-6 sm:px-6 lg:px-8">
                    <p class="text-sm/6 font-medium text-gray-500">Total Deposits</p>
                    <p class="mt-2 flex items-baseline gap-x-2">
                        <span class="text-4xl font-semibold tracking-tight text-gray-900">{{.TotalDepositsFormatted}}</span>
                    </p>
                </div>

                <!-- Total Portfolio Profit -->
                <div class="bg-white px-4 py-6 sm:px-6 lg:px-8">
                    <p class="text-sm/6 font-medium text-gray-500">Total Profit</p>
                    <p class="mt-2 flex items-baseline gap-x-2">
                        <span class="text-4xl font-semibold tracking-tight text-green-600">{{.TotalPortfolioProfitFormatted}}</span>
                    </p>
                </div>

                <!-- Portfolio Return Percentage -->
                <div class="bg-white px-4 py-6 sm:px-6 lg:px-8">
                    <p class="text-sm/6 font-medium text-gray-500">Portfolio Return</p>
                    <p class="mt-2 flex items-baseline gap-x-2">
                        <span class="text-4xl font-semibold tracking-tight text-gray-900">{{.TotalPortfolioProfitPercentageFormatted}}</span>
                    </p>
                </div>

                <!-- Total Premiums Collected -->
                <div class="bg-white px-4 py-6 sm:px-6 lg:px-8">
                    <p class="text-sm/6 font-medium text-gray-500">Total Premiums Collected</p>
                    <p class="mt-2 flex items-baseline gap-x-2">
                        <span class="text-4xl font-semibold tracking-tight text-gray-900">{{.TotalPremiumsFormatted}}</span>
                    </p>
                </div>

                <!-- Total Stock Profit -->
                <div class="bg-white px-4 py-6 sm:px-6 lg:px-8">
                    <p class="text-sm/6 font-medium text-gray-500">Total Stock Profit</p>
                    <p class="mt-2 flex items-baseline gap-x-2">
                        <span class="text-4xl font-semibold tracking-tight text-gray-900">{{.TotalStockProfitFormatted}}</span>
                    </p>
                </div>
                
                <!-- Premium Per Day -->
                <div class="bg-white px-4 py-6 sm:px-6 lg:px-8">
                    <p class="text-sm/6 font-medium text-gray-500">Premium Per Day</p>
                    <p class="mt-2 flex items-baseline gap-x-2">
                        <span class="text-4xl font-semibold tracking-tight text-gray-900">{{.PremiumPerDayFormatted}}</span>
                    </p>
                </div>
                
                <!-- Average Return Per Trade -->
                <div class="bg-white px-4 py-6 sm:px-6 lg:px-8">
                    <p class="text-sm/6 font-medium text-gray-500">Avg Return Per Option</p>
                    <p class="mt-2 flex items-baseline gap-x-2">
                        <span class="text-4xl font-semibold tracking-tight text-gray-900">{{.AvgReturnPerTradeFormatted}}</span>
                    </p>
                </div>
                
                <!-- Largest Premium -->
                <div class="bg-white px-4 py-6 sm:px-6 lg:px-8">
                    <p class="text-sm/6 font-medium text-gray-500">Largest Premium</p>
                    <p class="mt-2 flex items-baseline gap-x-2">
                        <span class="text-4xl font-semibold tracking-tight text-gray-900">{{.LargestPremiumFormatted}}</span>
                    </p>
                </div>
                
                <!-- Smallest Premium -->
                <div class="bg-white px-4 py-6 sm:px-6 lg:px-8">
                    <p class="text-sm/6 font-medium text-gray-500">Smallest Premium</p>
                    <p class="mt-2 flex items-baseline gap-x-2">
                        <span class="text-4xl font-semibold tracking-tight text-gray-900">{{.SmallestPremiumFormatted}}</span>
                    </p>
                </div>
                
                <!-- Average Premium -->
                <div class="bg-white px-4 py-6 sm:px-6 lg:px-8">
                    <p class="text-sm/6 font-medium text-gray-500">Average Premium</p>
                    <p class="mt-2 flex items-baseline gap-x-2">
                        <span class="text-4xl font-semibold tracking-tight text-gray-900">{{.AveragePremiumFormatted}}</span>
                    </p>
                </div>
                
                <!-- Number of Option Trades -->
                <div class="bg-white px-4 py-6 sm:px-6 lg:px-8">
                    <p class="text-sm/6 font-medium text-gray-500">Number of Option Trades</p>
                    <p class="mt-2 flex items-baseline gap-x-2">
                        <span class="text-4xl font-semibold tracking-tight text-gray-900">{{.OptionTradesCount}}</span>
                    </p>
                </div>
                
                <!-- Number of Stock Trades -->
                <div class="bg-white px-4 py-6 sm:px-6 lg:px-8">
                    <p class="text-sm/6 font-medium text-gray-500">Number of Stock Trades</p>
                    <p class="mt-2 flex items-baseline gap-x-2">
                        <span class="text-4xl font-semibold tracking-tight text-gray-900">{{.StockTradesCount}}</span>
                    </p>
                </div>
                
                <!-- Total Number of Trades -->
                <div class="bg-white px-4 py-6 sm:px-6 lg:px-8">
                    <p class="text-sm/6 font-medium text-gray-500">Total Number of Trades</p>
                    <p class="mt-2 flex items-baseline gap-x-2">
                        <span class="text-4xl font-semibold tracking-tight text-gray-900">{{.TotalTradesCount}}</span>
                    </p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Daily Tab Content -->
    <div x-show="activeTab === 'daily'" class="bg-white p-6">
        <!-- Filter Buttons -->
        <div class="mb-4 flex space-x-2">
            <button @click="chartFilter = 'both'; updateChart()" 
                    :class="chartFilter === 'both' ? 'bg-indigo-600 text-white' : 'bg-white text-gray-700 border border-gray-300'"
                    class="px-4 py-2 rounded-md text-sm font-medium">
                Both
            </button>
            <button @click="chartFilter = 'premiums'; updateChart()" 
                    :class="chartFilter === 'premiums' ? 'bg-green-600 text-white' : 'bg-white text-gray-700 border border-gray-300'"
                    class="px-4 py-2 rounded-md text-sm font-medium">
                Premiums Only
            </button>
            <button @click="chartFilter = 'stocks'; updateChart()" 
                    :class="chartFilter === 'stocks' ? 'bg-blue-600 text-white' : 'bg-white text-gray-700 border border-gray-300'"
                    class="px-4 py-2 rounded-md text-sm font-medium">
                Stocks Only
            </button>
        </div>
        
        <!-- Chart Container -->
        <div class="relative h-96">
            <canvas id="dailyReturnsChart"></canvas>
        </div>
        
        <!-- No Data Message -->
        <div x-show="dailyData.length === 0" class="text-center text-gray-500 mt-8">
            No daily returns data available yet.
        </div>
    </div>

    <!-- Net Worth Tab Content -->
    <div x-show="activeTab === 'networth'" class="bg-white p-6">
        <!-- Chart Container -->
        <div class="relative h-96">
            <canvas id="netWorthChart"></canvas>
        </div>

        <!-- No Data Message -->
        <div x-show="netWorthData.length === 0" class="text-center text-gray-500 mt-8">
            No net worth data available yet.
        </div>
    </div>
</div>

<!-- Include Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{{end}}